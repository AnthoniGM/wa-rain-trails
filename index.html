<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/esri-leaflet@3.0.11/dist/esri-leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0/osmtogeojson.js" crossorigin=""></script>
<script>
(function(){
  // ---------- Helpers / UI ----------
  const msg = document.getElementById('msgBox');
  const err = document.getElementById('errBox');
  const showMsg = (t)=>{ msg.textContent=t; msg.style.display='block'; };
  const hideMsg = ()=>{ msg.style.display='none'; };
  const showErr = (t)=>{ err.textContent=(err.textContent? err.textContent+'\\n':'')+t; err.style.display='block'; console.error(t); };
  const clearErr= ()=>{ err.textContent=''; err.style.display='none'; };
  const showOk  = (t)=>{ const ok=document.createElement('div'); ok.style.cssText='position:absolute;top:140px;left:10px;z-index:1100;background:#fff;border-left:4px solid #2e7d32;padding:8px 10px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);font-size:13px;'; ok.textContent=t; document.getElementById('app').appendChild(ok); setTimeout(()=>ok.remove(), 1600); };

  // Catch errors so we see them on-screen
  window.addEventListener('error', e => showErr('JS error: ' + (e.message||e)));
  window.addEventListener('unhandledrejection', e => showErr('Promise rejection: ' + (e.reason && (e.reason.message||e.reason) || e)));

  // ---------- Map ----------
  const map = L.map('map', { zoomControl: true, preferCanvas: true });
  map.zoomControl.setPosition('topright');

  // Z-order panes
  map.createPane('basemap');   map.getPane('basemap').style.zIndex   = 300;
  map.createPane('qpe');       map.getPane('qpe').style.zIndex       = 350;
  map.createPane('counties');  map.getPane('counties').style.zIndex  = 500;
  map.createPane('trails');    map.getPane('trails').style.zIndex    = 520;
  map.createPane('state');     map.getPane('state').style.zIndex     = 550;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    pane:'basemap', attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  const AL_BOUNDS = [[30.137, -88.473], [35.008, -84.889]];
  map.fitBounds(AL_BOUNDS);

  // Rain (7-day)
  let rfcQpe;
  try {
    rfcQpe = L.esri.dynamicMapLayer({
      url: 'https://mapservices.weather.noaa.gov/raster/rest/services/obs/rfc_qpe/MapServer',
      layers: [56], opacity: 0.45, f: 'image', pane: 'qpe'
    }).addTo(map);
  } catch (e) { showErr('Rain layer init failed: ' + e); }

  document.getElementById('rainToggle').addEventListener('change', (e) => {
    if (!rfcQpe) return;
    e.target.checked ? rfcQpe.addTo(map) : map.removeLayer(rfcQpe);
  });

  // Trails
  const trailsLayer = L.geoJSON(null, {
    pane: 'trails', style: { color:'#0066cc', weight:3 },
    onEachFeature: (f, layer)=>{
      layer.on('click', ()=>{
        let latlng=null;
        try{
          const c=(f.geometry.type==='LineString')?f.geometry.coordinates[0]
                :(f.geometry.type==='MultiLineString'?f.geometry.coordinates[0][0]:null);
          if(c) latlng={lng:c[0], lat:c[1]};
        }catch(e){}
        const name=(f.properties&&(f.properties.name||f.properties.ref))||'Trail';
        const div=document.createElement('div');
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          <div>${latlng?`Trailhead (approx): <code>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</code>`:'Coordinates unavailable'}</div>
          <button class="copy-btn">Copy coordinates</button>`;
        const center=layer.getBounds?layer.getBounds().getCenter():(latlng?latlng:map.getCenter());
        L.popup().setLatLng(center).setContent(div).openOn(map);
        div.querySelector('.copy-btn').addEventListener('click', ()=>{
          const txt=latlng?`${latlng.lat}, ${latlng.lng}`:`${center.lat}, ${center.lng}`;
          navigator.clipboard.writeText(txt);
          div.querySelector('.copy-btn').textContent='Copied!';
          setTimeout(()=>div.querySelector('.copy-btn').textContent='Copy coordinates',1200);
        });
      });
    }
  }).addTo(map);

  document.getElementById('trailsToggle').addEventListener('change', (e)=>{
    e.target.checked?trailsLayer.addTo(map):map.removeLayer(trailsLayer);
  });

  // ---------- Boundaries with localStorage cache ----------
  const countyHover = document.getElementById('countyHover');
  const backBtn = document.getElementById('backBtn');
  let countiesLayer=null, stateLayer=null;

  const styleCounty      = () => ({ color:'#333', weight:1.4, fillOpacity:0, opacity:0.9 });
  const styleCountyHover = () => ({ color:'#111', weight:2.2, fillOpacity:0, opacity:1 });
  const styleState       = () => ({ color:'#000', weight:2.2, fillOpacity:0, opacity:1 });

  function safeOn(layer, evt, fn){
    if (layer && typeof layer.on==='function') layer.on(evt, fn);
  }
  function attachCountyEvents(layer){
    safeOn(layer, 'mouseover', (e)=>{ const tgt=e.target; if(!tgt) return;
      tgt.setStyle(styleCountyHover());
      const p=tgt.feature && tgt.feature.properties || {};
      const n=(p.NAME||p.NAMELSAD||p.NAME10||p.NAME20||'').toString();
      if(n){ countyHover.textContent=n+' County'; countyHover.style.display='block'; }
    });
    safeOn(layer, 'mouseout', (e)=>{ const tgt=e.target; if(!tgt||!countiesLayer||!countiesLayer.resetStyle) return;
      countiesLayer.resetStyle(tgt); countyHover.style.display='none';
    });
    safeOn(layer, 'click', (e)=>{ const tgt=e.target; if(!tgt) return;
      map.fitBounds(tgt.getBounds(), {padding:[20,20]}); backBtn.style.display='inline-block';
      loadTrailsForBounds(tgt.getBounds());
    });
  }

  backBtn.addEventListener('click', ()=>{
    map.fitBounds(AL_BOUNDS);
    backBtn.style.display='none';
    trailsLayer.clearLayers();
  });

  const LS_KEYS = {
    counties: 'al_counties_geojson_v1',
    state:    'al_state_geojson_v1',
    meta:     'al_geo_meta_v1'
  };
  const TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 days

  function getCache(){
    try{
      const meta = JSON.parse(localStorage.getItem(LS_KEYS.meta)||'{}');
      if (!meta.ts || (Date.now() - meta.ts) > TTL_MS) return null;
      const counties = JSON.parse(localStorage.getItem(LS_KEYS.counties)||'null');
      const state    = JSON.parse(localStorage.getItem(LS_KEYS.state)||'null');
      if (counties && state) return {counties, state};
    }catch(e){}
    return null;
  }
  function setCache(counties, state){
    try{
      localStorage.setItem(LS_KEYS.counties, JSON.stringify(counties));
      localStorage.setItem(LS_KEYS.state,    JSON.stringify(state));
      localStorage.setItem(LS_KEYS.meta,     JSON.stringify({ts:Date.now()}));
    }catch(e){ /* ignore quota */ }
  }

  async function fetchBoundaries(){
    // TIGERweb GeoJSON (forced to WGS84)
    const countiesUrl = 'https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/1/query?where=STATE%3D%2701%27&outFields=NAME,STATE,COUNTY,NAMELSAD&returnGeometry=true&outSR=4326&f=geojson';
    const stateUrl    = 'https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/0/query?where=STATE%3D%2701%27&outFields=NAME,STATE&returnGeometry=true&outSR=4326&f=geojson';
    const [r1,r2] = await Promise.all([fetch(countiesUrl), fetch(stateUrl)]);
    if(!r1.ok) throw new Error('Counties HTTP '+r1.status);
    if(!r2.ok) throw new Error('State HTTP '+r2.status);
    const [gj1, gj2] = await Promise.all([r1.json(), r2.json()]);
    return {counties: gj1, state: gj2};
  }

  function drawBoundaries(gj, sourceLabel){
    if (countiesLayer) { map.removeLayer(countiesLayer); }
    if (stateLayer) { map.removeLayer(stateLayer); }
    countiesLayer = L.geoJSON(gj.counties, { pane:'counties', style: styleCounty, onEachFeature: (f, layer)=>attachCountyEvents(layer) }).addTo(map);
    stateLayer    = L.geoJSON(gj.state,    { pane:'state',    style: styleState }).addTo(map);
    showOk(`Counties loaded (${sourceLabel})${gj.counties.features ? ' — '+gj.counties.features.length+' counties' : ''}`);
  }

  async function loadBoundaries(){
    clearErr();
    const cache = getCache();
    if (cache){
      drawBoundaries(cache, 'cache');
      // also refresh in background to keep cache warm (no UI block)
      try { const fresh = await fetchBoundaries(); setCache(fresh.counties, fresh.state); } catch(_) {}
      return;
    }
    showMsg('Loading county/state outlines…');
    try{
      const fresh = await fetchBoundaries();
      hideMsg();
      setCache(fresh.counties, fresh.state);
      drawBoundaries(fresh, 'network');
    }catch(e){
      hideMsg();
      showErr('Boundaries failed: ' + e);
    }
  }

  loadBoundaries();

  // Trails fetcher
  async function loadTrailsForBounds(bounds){
    trailsLayer.clearLayers();
    showMsg('Loading trails…');
    const bbox = [bounds.getSouth(), bounds.getWest(), bounds.getNorth(), bounds.getEast()].join(',');
    const query = `
      [out:json][timeout:25];
      (
        relation["route"="hiking"](${bbox});
        way["highway"~"path|footway|track"]["foot"!~"no"](${bbox});
      );
      out geom;`;
    const url = 'https://overpass-api.de/api/interpreter';
    try{
      const res = await fetch(url, { method:'POST', body: query, headers:{'Content-Type':'text/plain'} });
      const data = await res.json();
      const features = osmtogeojson(data).features;
      if (!features.length) showMsg('No mapped trails found for this county (OSM). Try zooming or another county.');
      else hideMsg();
      trailsLayer.addData(features);
    } catch(err){
      showMsg('Could not load trails right now. Please try again.');
      showErr('Overpass request failed: '+err);
    }
  }
})();
</script>
