<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alabama Rain + Trails (Fast)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<style>
  html,body{margin:0;height:100%}
  #app{height:100vh;position:relative;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  #map{height:100%}
  .toolbar{position:absolute;top:10px;left:10px;z-index:1200;background:#fff;border-radius:12px;padding:8px 10px;box-shadow:0 2px 10px rgba(0,0,0,.2);display:flex;gap:10px;align-items:center;font-size:14px}
  .btn{cursor:pointer;border:none;border-radius:10px;padding:6px 10px;background:#f2f2f2}
  .btn:hover{background:#e8e8e8}
  .legend{position:absolute;bottom:10px;left:10px;z-index:1100;background:#fff;border-radius:12px;padding:8px 10px;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:12px;max-width:300px;line-height:1.35}
  .county-hover{position:absolute;top:10px;right:10px;z-index:1100;background:#212121;color:#fff;padding:6px 10px;border-radius:10px;opacity:.9;display:none}
  .msg{position:absolute;top:60px;left:10px;z-index:1100;background:#fff;border-left:4px solid #1976d2;padding:8px 10px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);font-size:13px;display:none}
  .slider-wrap{display:flex;align-items:center;gap:6px}
  .slider{width:150px}
  code.copyable{user-select:all}
</style>
</head>
<body>
<div id="app">
  <div class="toolbar">
    <button id="backBtn" class="btn" style="display:none">← Back</button>

    <label><input id="rainToggle" type="checkbox" checked> Rain</label>

    <div class="slider-wrap" title="Rain opacity">
      <span>Opacity</span>
      <input id="opacitySlider" class="slider" type="range" min="0" max="0.8" step="0.05" value="0.45" />
      <span id="opacityVal">0.45</span>
    </div>

    <label><input id="trailsToggle" type="checkbox" checked> Trails</label>
  </div>

  <div class="msg" id="msgBox"></div>
  <div class="county-hover" id="countyHover"></div>
  <div id="map"></div>

  <div class="legend">
    <div><strong>Alabama Rain (Last 7 Days) + Trails</strong></div>
    <div>• Hover a county to highlight it. Click to drill in (county + neighbors).</div>
    <div>• Trails (in detail view): hover to see name, click to copy trailhead coords.</div>
    <div style="margin-top:6px;font-size:11px">Rain: NOAA RFC QPE. Boundaries: local TopoJSON. Trails: OpenStreetMap.</div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/esri-leaflet@3.0.11/dist/esri-leaflet.js" crossorigin></script>

<script>
(async function(){
  // UI helpers
  const msg = document.getElementById('msgBox');
  const showMsg = (t)=>{ msg.textContent=t; msg.style.display='block'; };
  const hideMsg = ()=>{ msg.style.display='none'; };
  const countyHoverEl = document.getElementById('countyHover');
  const backBtn = document.getElementById('backBtn');

  // Map & panes
  const map = L.map('map', { zoomControl:true, preferCanvas:true });
  map.zoomControl.setPosition('topright');

  map.createPane('base');     map.getPane('base').style.zIndex = 300;
  map.createPane('rain');     map.getPane('rain').style.zIndex = 350;
  map.createPane('mask');     map.getPane('mask').style.zIndex = 400; // darken outside
  map.createPane('counties'); map.getPane('counties').style.zIndex = 500;
  map.createPane('trails');   map.getPane('trails').style.zIndex = 520;

  // Basemap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{pane:'base', attribution:'© OpenStreetMap'}).addTo(map);

  // Fit to Alabama (loose bounds)
  const AL_BOUNDS = [[30.137,-88.473],[35.008,-84.889]];
  map.fitBounds(AL_BOUNDS);

  // --- Load local TopoJSON (Alabama counties) ---
  let topo;
  try {
    const r = await fetch('./data/alabama-counties.topo.json');
    if (!r.ok) throw new Error('local 404');
    topo = await r.json();
  } catch {
    // fallback if the local file isn't present yet
    const r2 = await fetch('https://raw.githubusercontent.com/jethin/us-counties-tracts-topojson/main/counties/01.topo.json');
    topo = await r2.json();
  }

  // Convert TopoJSON -> GeoJSON (counties)
  const topoObjName = Object.keys(topo.objects)[0];
  const countiesFC = topojson.feature(topo, topo.objects[topoObjName]);

  // Build a fast neighbor map (bbox-based)
  const feats = countiesFC.features;
  feats.forEach((f,i)=>{ f._idx=i; f._bbox = L.geoJSON(f).getBounds(); });
  const neighbors = new Map(); for (let i=0;i<feats.length;i++) neighbors.set(i,new Set());
  for (let i=0;i<feats.length;i++){
    for (let j=i+1;j<feats.length;j++){
      if (feats[i]._bbox.intersects(feats[j]._bbox)) { neighbors.get(i).add(j); neighbors.get(j).add(i); }
    }
  }

  // Create a state outline mesh to use for the initial mask
  const mesh = topojson.mesh(topo, topo.objects[topoObjName], (a,b)=>a!==b);
  L.geoJSON({type:'Feature', geometry: mesh}, {pane:'counties', style:{color:'#000', weight:2, fillOpacity:0}}).addTo(map);

  // County layer (hover highlight + click to drill)
  const countiesLayer = L.geoJSON(countiesFC, {
    pane:'counties',
    style: { color:'#444', weight:1.2, fillOpacity:0 },
    onEachFeature: (f, layer) => {
      layer.on('mouseover', e=>{
        e.target.setStyle({weight:2.2, color:'#111'});
        const name = (f.properties && (f.properties.name || f.properties.NAME || f.properties.NAMELSAD)) || 'County';
        countyHoverEl.textContent = name + ' County'; countyHoverEl.style.display = 'block';
      });
      layer.on('mouseout', e=>{
        countiesLayer.resetStyle(e.target);
        countyHoverEl.style.display = 'none';
      });
      layer.on('click', ()=> enterCountyView(f));
    }
  }).addTo(map);

  // Visual mask: show only inside provided polygon(s)
  let maskLayer = null;
  function setMask(allowedGeoJSON){
    if (maskLayer) { map.removeLayer(maskLayer); maskLayer = null; }
    const world = [[-90,-180],[-90,180],[90,180],[90,-180]];
    const holes = [];
    const addHole = (geom) => {
      if (geom.type === 'Polygon') holes.push(geom.coordinates[0].map(([x,y])=>[y,x]));
      if (geom.type === 'MultiPolygon') geom.coordinates.forEach(r=>holes.push(r[0].map(([x,y])=>[y,x])));
    };
    if (allowedGeoJSON.type === 'FeatureCollection') allowedGeoJSON.features.forEach(f=>addHole(f.geometry));
    else if (allowedGeoJSON.type === 'Feature') addHole(allowedGeoJSON.geometry);
    else addHole(allowedGeoJSON);
    maskLayer = L.polygon([world, ...holes], { pane:'mask', stroke:false, fill:true, fillColor:'#000', fillOpacity:0.35, interactive:false }).addTo(map);
  }

  // Initial mask = entire Alabama (from mesh)
  setMask({type:'Feature', geometry: mesh});

  // --- Rain raster (NOAA RFC QPE, last 7 days) ---
  let rain = L.esri.dynamicMapLayer({
    url: 'https://mapservices.weather.noaa.gov/raster/rest/services/obs/rfc_qpe/MapServer',
    layers: [56],          // "Last 7 Days Observed" image layer
    opacity: 0.45,         // default; slider can change it 0..0.8
    f: 'image',
    pane: 'rain'
  }).addTo(map);

  // Rain toggle
  document.getElementById('rainToggle').addEventListener('change', e=>{
    if (!rain) return;
    e.target.checked ? rain.addTo(map) : map.removeLayer(rain);
  });

  // Rain opacity slider
  const slider = document.getElementById('opacitySlider');
  const opVal  = document.getElementById('opacityVal');
  function setOpacity(v){ if(rain && typeof rain.setOpacity==='function'){ rain.setOpacity(v); opVal.textContent = (+v).toFixed(2); } }
  slider.addEventListener('input', (e)=> setOpacity(e.target.value));
  setOpacity(slider.value);

  // --- Trails (RED) — used in county+neighbors view ---
  const trailsLayer = L.geoJSON(null, {
    pane:'trails',
    style:{ color:'#d32f2f', weight:3.5 },
    onEachFeature: (f, layer) => {
      const name = (f.properties && f.properties.name) ? f.properties.name : 'Trail';
      // Hover name (sticky tooltip)
      layer.bindTooltip(name, {sticky:true, direction:'top', opacity:0.9});
      // Click popup with copyable coords
      layer.on('click', ()=>{
        // Approximate trailhead = first coord
        let latlng=null;
        try{
          if (f.geometry && f.geometry.type==='LineString' && f.geometry.coordinates.length){
            const c=f.geometry.coordinates[0]; latlng={lng:c[0],lat:c[1]};
          } else if (f.geometry && f.geometry.type==='MultiLineString' && f.geometry.coordinates[0] && f.geometry.coordinates[0].length){
            const c=f.geometry.coordinates[0][0]; latlng={lng:c[0],lat:c[1]};
          }
        }catch(_){}
        const div=document.createElement('div');
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          <div>${latlng ? `Trailhead (approx): <code class="copyable">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</code>` : 'Coordinates unavailable'}</div>
          <button id="copyBtn" class="btn" style="margin-top:6px;">Copy coordinates</button>`;
        const center = layer.getBounds ? layer.getBounds().getCenter() : (latlng ? latlng : map.getCenter());
        L.popup().setLatLng(center).setContent(div).openOn(map);
        div.querySelector('#copyBtn').addEventListener('click', ()=>{
          const text = latlng ? `${latlng.lat}, ${latlng.lng}` : `${center.lat}, ${center.lng}`;
          navigator.clipboard.writeText(text);
          div.querySelector('#copyBtn').textContent='Copied!';
          setTimeout(()=>div.querySelector('#copyBtn').textContent='Copy coordinates', 1200);
        });
      });
    }
  }).addTo(map);

  document.getElementById('trailsToggle').addEventListener('change', e=>{
    e.target.checked ? trailsLayer.addTo(map) : map.removeLayer(trailsLayer);
  });

  // Enter county view: mask to county + neighbors, zoom, then fetch trails for the COMBINED bbox
  async function enterCountyView(countyFeature){
    showMsg('Loading county + neighbors…');

    const i = countyFeature._idx;
    const neighIdx = Array.from(neighbors.get(i) || []);
    const keep = [countyFeature, ...neighIdx.map(j=>feats[j])];
    const fc = { type:'FeatureCollection', features: keep };
    setMask(fc); // mask to county + adjacent counties
    backBtn.style.display = 'inline-block';

    // Zoom to combined bounds (selected + neighbors) — fill the screen
    let combined = null;
    keep.forEach(f=>{
      const b = L.geoJSON(f).getBounds();
      combined = combined ? combined.extend(b) : b;
    });
    
    // minimal padding overall; a little extra at the top so the toolbar doesn’t overlap
    map.fitBounds(combined, {
      paddingTopLeft: [8, 70],   // leave room for the toolbar
      paddingBottomRight: [8, 8]
    });

    // Trails: fetch within combined bbox
    trailsLayer.clearLayers();
    showMsg('Loading trails…');
    try{
      const b = combined;
      const bbox = [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()].join(',');
      const q = `
        [out:json][timeout:25];
        (
          relation["route"="hiking"](${bbox});
          way["highway"~"path|footway|track"]["foot"!~"no"](${bbox});
        ); out geom;`;
      const res = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', headers:{'Content-Type':'text/plain'}, body:q});
      const data = await res.json();

      // Convert Overpass features to simple LineString GeoJSON
      const features = [];
      if (data.elements) {
        for (const el of data.elements) {
          if ((el.type==='way' || el.type==='relation') && el.geometry) {
            const coords = el.geometry.map(p=>[p.lon, p.lat]);
            const nm = el.tags && el.tags.name;
            features.push({ type:'Feature', properties:{ name: nm || 'Trail' }, geometry:{ type:'LineString', coordinates: coords }});
          }
        }
      }
      if (features.length === 0) showMsg('No mapped trails here yet (OSM).'); else hideMsg();
      trailsLayer.addData({type:'FeatureCollection', features});
    }catch(e){
      showMsg('Trails are busy. Try again.');
      console.error(e);
    }
  }

  backBtn.addEventListener('click', ()=>{
    trailsLayer.clearLayers();
    // Back to whole Alabama
    const mesh = topojson.mesh(topo, topo.objects[topoObjName], (a,b)=>a!==b);
    setMask({type:'Feature', geometry: mesh});
    map.fitBounds(AL_BOUNDS);
    backBtn.style.display = 'none';
  });
})();
</script>
</body>
</html>
