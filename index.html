<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alabama Rain + Trails</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<style>
  html,body{margin:0;height:100%}
  #app{height:100%;position:relative;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  #map{height:100%}
  .toolbar{position:absolute;top:10px;left:10px;z-index:1200;background:#fff;border-radius:12px;padding:8px 10px;box-shadow:0 2px 10px rgba(0,0,0,.12);display:flex;gap:10px;align-items:center;font-size:14px;flex-wrap:wrap}
  .btn{cursor:pointer;border:none;border-radius:10px;padding:6px 10px;background:#f2f2f2}
  .btn:hover{background:#e8e8e8}
  .legend{position:absolute;bottom:10px;left:10px;z-index:1100;background:#fff;border-radius:12px;padding:8px 10px;box-shadow:0 2px 10px rgba(0,0,0,.12);font-size:12px;max-width:300px;line-height:1.35}
  .county-hover{position:absolute;top:10px;right:10px;z-index:1100;background:#212121;color:#fff;padding:6px 10px;border-radius:10px;opacity:.95;display:none}
  .msg{position:absolute;top:60px;left:10px;z-index:1100;background:#fff;border-left:4px solid #1976d2;padding:8px 10px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.12);font-size:13px;display:none}
  .slider-wrap{display:flex;align-items:center;gap:6px}
  .slider{width:150px}
  code.copyable{user-select:all}
</style>
</head>
<body>
<div id="app">
  <div class="toolbar">
    <button id="backBtn" class="btn" style="display:none">← Back</button>

    <label><input id="rainToggle" type="checkbox" checked> Rain</label>

    <div class="slider-wrap" title="Rain opacity">
      <span>Opacity</span>
      <input id="opacitySlider" class="slider" type="range" min="0" max="0.8" step="0.05" value="0.45" />
      <span id="opacityVal">0.45</span>
    </div>

    <!-- NEW: Days slider -->
    <div class="slider-wrap" title="Cumulative days of observed precipitation">
      <span>Days</span>
      <input id="daysSlider" class="slider" type="range" min="0" max="8" step="1" />
      <span id="daysVal">7</span>
    </div>

    <label><input id="trailsToggle" type="checkbox" checked> Trails</label>
  </div>

  <div class="msg" id="msgBox"></div>
  <div class="county-hover" id="countyHover"></div>
  <div id="map"></div>

  <div class="legend">
    <div><strong>Alabama Rain (Last <span id="legendDays">7</span> Days) + Trails</strong></div>
    <div>• Hover a county to highlight it. Click to drill in (county + neighbors).</div>
    <div>• Trails: hover for name, click to copy coords.</div>
    <div style="margin-top:6px;font-size:11px">
      Rain: NOAA RFC QPE (fixed multi‑day composites 1–14 days; 21‑day not provided by this service). Trails: OpenStreetMap.
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/esri-leaflet@3.0.11/dist/esri-leaflet.js" crossorigin></script>

<script>
(async function(){
  // --- URL param defaults ---
  const params = new URLSearchParams(location.search);
  const DEFAULT_OPACITY = Math.max(0, Math.min(0.8, parseFloat(params.get('opacity') || '0.45')));
  const DEFAULT_RAIN   = params.get('rain')   !== '0'; // default on
  const DEFAULT_TRAILS = params.get('trails') !== '0'; // default on

  // NOAA provides fixed multi-day composites. We'll snap to these stops:
  // index:   0 1 2 3 4 5 6 7  8
  const DAYS_STOPS = [1,2,3,4,5,6,7,10,14];
  // Map "days" to ArcGIS Image layer IDs (Observed → Image for Last N Days)
  // Source lists: 1d img=28, 2d=36, 3d=40, 4d=44, 5d=48, 6d=52, 7d=56, 10d=60, 14d=64. :contentReference[oaicite:1]{index=1}
  const LAYER_BY_DAYS = {1:28, 2:36, 3:40, 4:44, 5:48, 6:52, 7:56, 10:60, 14:64};

  // Optional URL param to set initial days (snaps to nearest stop)
  const urlDays = parseInt(params.get('days') || '7', 10);
  function nearestStopIndex(n){
    let bestI=0, bestDiff=Infinity;
    for (let i=0;i<DAYS_STOPS.length;i++){
      const d = Math.abs(DAYS_STOPS[i]-n);
      if (d<bestDiff){ bestDiff=d; bestI=i; }
    }
    return bestI;
  }
  const DEFAULT_DAYS_INDEX = nearestStopIndex(isNaN(urlDays)?7:urlDays);

  // UI helpers
  const msg = document.getElementById('msgBox');
  const showMsg = (t)=>{ msg.textContent=t; msg.style.display='block'; };
  const hideMsg = ()=>{ msg.style.display='none'; };
  const countyHoverEl = document.getElementById('countyHover');
  const backBtn = document.getElementById('backBtn');

  // Apply defaults before creating layers
  const rainToggleEl   = document.getElementById('rainToggle');
  const trailsToggleEl = document.getElementById('trailsToggle');
  const sliderEl       = document.getElementById('opacitySlider');
  const opValEl        = document.getElementById('opacityVal');
  const daysSliderEl   = document.getElementById('daysSlider');
  const daysValEl      = document.getElementById('daysVal');
  const legendDaysEl   = document.getElementById('legendDays');

  rainToggleEl.checked   = DEFAULT_RAIN;
  trailsToggleEl.checked = DEFAULT_TRAILS;
  sliderEl.value         = DEFAULT_OPACITY.toString();
  opValEl.textContent    = DEFAULT_OPACITY.toFixed(2);

  // Init days slider
  daysSliderEl.min = 0;
  daysSliderEl.max = DAYS_STOPS.length - 1;
  daysSliderEl.step = 1;
  daysSliderEl.value = DEFAULT_DAYS_INDEX.toString();
  daysValEl.textContent = DAYS_STOPS[DEFAULT_DAYS_INDEX];
  legendDaysEl.textContent = DAYS_STOPS[DEFAULT_DAYS_INDEX];

  // Bounds for Alabama
  const AL_BOUNDS = L.latLngBounds([30.137,-88.473],[35.008,-84.889]);

  // Map & panes
  const map = L.map('map', {
    zoomControl:true,
    preferCanvas:true,
    maxBounds: AL_BOUNDS.pad(0.05),
    maxBoundsViscosity: 1.0,
    worldCopyJump:false
  });
  map.zoomControl.setPosition('topright');

  map.createPane('base');     map.getPane('base').style.zIndex = 300;
  map.createPane('rain');     map.getPane('rain').style.zIndex = 350;
  map.createPane('mask');     map.getPane('mask').style.zIndex = 400; // BELOW county lines
  map.createPane('counties'); map.getPane('counties').style.zIndex = 500;
  map.createPane('trails');   map.getPane('trails').style.zIndex = 520;

  // Basemap
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    pane:'base', attribution:'© OpenStreetMap', noWrap:true
  }).addTo(map);

  // Start view
  map.fitBounds(AL_BOUNDS);

  // --- Load local TopoJSON (Alabama counties) ---
  let topo;
  try {
    const r = await fetch('./data/alabama-counties.topo.json');
    if (!r.ok) throw new Error('local 404');
    topo = await r.json();
  } catch {
    const r2 = await fetch('https://raw.githubusercontent.com/jethin/us-counties-tracts-topojson/main/counties/01.topo.json');
    topo = await r2.json();
  }

  // Convert TopoJSON -> GeoJSON (counties)
  const topoObjName = Object.keys(topo.objects)[0];
  const countiesFC = topojson.feature(topo, topo.objects[topoObjName]);

  // Build a true state polygon (union of all counties) for masking
  const STATE_POLY = topojson.merge(topo, topo.objects[topoObjName].geometries);

  // Neighbor map (bbox-based)
  const feats = countiesFC.features;
  feats.forEach((f,i)=>{ f._idx=i; f._bbox = L.geoJSON(f).getBounds(); });
  const neighbors = new Map(); for (let i=0;i<feats.length;i++) neighbors.set(i,new Set());
  for (let i=0;i<feats.length;i++){
    for (let j=i+1;j<feats.length;j++){
      if (feats[i]._bbox.intersects(feats[j]._bbox)) { neighbors.get(i).add(j); neighbors.get(j).add(i); }
    }
  }

  // State outline (for reference)
  const meshOutline = topojson.mesh(topo, topo.objects[topoObjName], (a,b)=>a!==b);
  L.geoJSON({type:'Feature', geometry: meshOutline}, {pane:'counties', style:{color:'#000', weight:2, fillOpacity:0}}).addTo(map);

  // County layer (hover + click)
  const countiesLayer = L.geoJSON(countiesFC, {
    pane:'counties',
    style: { color:'#444', weight:1.2, fillOpacity:0 },
    onEachFeature: (f, layer) => {
      layer.on('mouseover', e=>{
        e.target.setStyle({weight:2.2, color:'#111'});
        const name = (f.properties && (f.properties.name || f.properties.NAME || f.properties.NAMELSAD)) || 'County';
        countyHoverEl.textContent = name + ' County'; countyHoverEl.style.display = 'block';
      });
      layer.on('mouseout', e=>{
        countiesLayer.resetStyle(e.target);
        countyHoverEl.style.display = 'none';
      });
      layer.on('click', ()=> enterCountyView(f));
    }
  }).addTo(map);

  // Visual mask: fully hide everything outside the polygon(s)
  let maskLayer = null;
  const MASK_OPACITY = 1.0; // fully opaque outside
  function setMask(allowed){
    if (maskLayer) { map.removeLayer(maskLayer); maskLayer = null; }
    const world = [[-90,-180],[-90,180],[90,180],[90,-180]];
    const holes = [];
    const addHole = (geom) => {
      if (!geom) return;
      if (geom.type === 'Polygon') holes.push(geom.coordinates[0].map(([x,y])=>[y,x]));
      if (geom.type === 'MultiPolygon') geom.coordinates.forEach(r=>holes.push(r[0].map(([x,y])=>[y,x])));
      if (geom.type === 'GeometryCollection') geom.geometries.forEach(g=>addHole(g));
    };
    if (allowed.type === 'FeatureCollection') allowed.features.forEach(f=>addHole(f.geometry));
    else if (allowed.type === 'Feature') addHole(allowed.geometry);
    else addHole(allowed);

    maskLayer = L.polygon([world, ...holes], {
      pane:'mask', stroke:false, fill:true, fillColor:'#fff', fillOpacity: MASK_OPACITY, interactive:false
    }).addTo(map);
  }

  // Statewide mask uses real polygon so rain shows at state view
  setMask({type:'Feature', geometry: STATE_POLY});

  // --- Rain raster (NOAA RFC QPE, multi-day observed) ---
  function currentDays(){ return DAYS_STOPS[ parseInt(daysSliderEl.value,10) ]; }
  function currentLayerId(){ return LAYER_BY_DAYS[ currentDays() ]; }

  let rain = L.esri.dynamicMapLayer({
    url: 'https://mapservices.weather.noaa.gov/raster/rest/services/obs/rfc_qpe/MapServer',
    layers: [ currentLayerId() ],         // Last N Days Observed (Image)
    opacity: DEFAULT_OPACITY,
    f: 'image',
    pane: 'rain'
  }).addTo(map);

  // Rain toggle + opacity + days slider
  function setOpacity(v){ if(rain && rain.setOpacity){ rain.setOpacity(v); opValEl.textContent=(+v).toFixed(2);} }
  function setDaysFromSlider(){
    const d = currentDays();
    const lyr = currentLayerId();
    legendDaysEl.textContent = d;
    daysValEl.textContent = d;
    // swap the layer efficiently
    if (rain && typeof rain.setLayers==='function'){ rain.setLayers([lyr]); }
  }

  document.getElementById('rainToggle').addEventListener('change', e=>{
    if (!rain) return;
    e.target.checked ? rain.addTo(map) : map.removeLayer(rain);
  });
  sliderEl.addEventListener('input', (e)=> setOpacity(e.target.value));
  daysSliderEl.addEventListener('input', setDaysFromSlider);

  setOpacity(DEFAULT_OPACITY);
  setDaysFromSlider();
  if (!DEFAULT_RAIN) map.removeLayer(rain); // honor URL param

  // --- Trails (RED) — used in county+neighbors view ---
  const trailsLayer = L.geoJSON(null, {
    pane:'trails',
    style:{ color:'#d32f2f', weight:3.5 },
    onEachFeature: (f, layer) => {
      const name = (f.properties && f.properties.name) ? f.properties.name : 'Trail';
      layer.bindTooltip(name, {sticky:true, direction:'top', opacity:0.95});
      layer.on('click', ()=>{
        let latlng=null;
        try{
          if (f.geometry && f.geometry.type==='LineString' && f.geometry.coordinates.length){
            const c=f.geometry.coordinates[0]; latlng={lng:c[0],lat:c[1]};
          } else if (f.geometry && f.geometry.type==='MultiLineString' && f.geometry.coordinates[0] && f.geometry.coordinates[0].length){
            const c=f.geometry.coordinates[0][0]; latlng={lng:c[0],lat:c[1]};
          }
        }catch(_){}
        const div=document.createElement('div');
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          <div>${latlng ? `Trailhead (approx): <code class="copyable">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</code>` : 'Coordinates unavailable'}</div>
          <button id="copyBtn" class="btn" style="margin-top:6px;">Copy coordinates</button>`;
        const center = layer.getBounds ? layer.getBounds().getCenter() : (latlng ? latlng : map.getCenter());
        L.popup().setLatLng(center).setContent(div).openOn(map);
        div.querySelector('#copyBtn').addEventListener('click', ()=>{
          const text = latlng ? `${latlng.lat}, ${latlng.lng}` : `${center.lat}, ${center.lng}`;
          navigator.clipboard.writeText(text);
          div.querySelector('#copyBtn').textContent='Copied!';
          setTimeout(()=>div.querySelector('#copyBtn').textContent='Copy coordinates', 1200);
        });
      });
    }
  }).addTo(map);
  if (!DEFAULT_TRAILS) map.removeLayer(trailsLayer);

  document.getElementById('trailsToggle').addEventListener('change', e=>{
    e.target.checked ? trailsLayer.addTo(map) : map.removeLayer(trailsLayer);
  });

  // Enter county view: mask to county + neighbors, zoom to combined bounds, fetch trails
  async function enterCountyView(countyFeature){
    showMsg('Loading county + neighbors…');

    const i = countyFeature._idx;
    const neighIdx = Array.from(neighbors.get(i) || []);
    const keep = [countyFeature, ...neighIdx.map(j=>feats[j])];
    const fc = { type:'FeatureCollection', features: keep };
    setMask(fc); // fully hide outside the combined shape
    backBtn.style.display = 'inline-block';

    // Edge-to-edge fit (leave top padding for toolbar)
    let combined = null;
    keep.forEach(f=>{
      const b = L.geoJSON(f).getBounds();
      combined = combined ? combined.extend(b) : b;
    });
    map.fitBounds(combined, {
      paddingTopLeft: [8, 70],
      paddingBottomRight: [8, 8]
    });

    // Trails: fetch within combined bbox
    trailsLayer.clearLayers();
    showMsg('Loading trails…');
    try{
      const b = combined;
      const bbox = [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()].join(',');
      const q = `
        [out:json][timeout:25];
        (
          relation["route"="hiking"](${bbox});
          way["highway"~"path|footway|track"]["foot"!~"no"](${bbox});
        ); out geom;`;
      const res = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', headers:{'Content-Type':'text/plain'}, body:q});
      const data = await res.json();

      const features = [];
      if (data.elements) {
        for (const el of data.elements) {
          if ((el.type==='way' || el.type==='relation') && el.geometry) {
            const coords = el.geometry.map(p=>[p.lon, p.lat]);
            const nm = el.tags && el.tags.name;
            features.push({ type:'Feature', properties:{ name: nm || 'Trail' }, geometry:{ type:'LineString', coordinates: coords }});
          }
        }
      }
      if (features.length === 0) showMsg('No mapped trails here yet (OSM).'); else hideMsg();
      trailsLayer.addData({type:'FeatureCollection', features});
      if (!trailsToggleEl.checked) map.removeLayer(trailsLayer); // respect toggle state
    }catch(e){
      showMsg('Trails are busy. Try again.');
      console.error(e);
    }
  }

  // Back to statewide view
  backBtn.addEventListener('click', ()=>{
    trailsLayer.clearLayers();
    setMask({type:'Feature', geometry: STATE_POLY}); // statewide mask
    map.fitBounds(AL_BOUNDS);
    backBtn.style.display = 'none';
    hideMsg();
  });
})();
</script>
</body>
</html>
