<script>
(function(){
  const msg = document.getElementById('msgBox');
  const showMsg = (t)=>{ msg.textContent=t; msg.style.display='block'; };
  const hideMsg = ()=>{ msg.style.display='none'; };

  // Leaflet map
  const map = L.map('map', { zoomControl: true, preferCanvas: true });

  // Create panes to control z-order (lower number = underneath)
  map.createPane('qpe');       map.getPane('qpe').style.zIndex = 200;   // rain
  map.createPane('basemap');   map.getPane('basemap').style.zIndex = 300;
  map.createPane('counties');  map.getPane('counties').style.zIndex = 450;
  map.createPane('state');     map.getPane('state').style.zIndex = 500;

  const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    pane:'basemap',
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Fit to Alabama
  const AL_BOUNDS = [[30.137, -88.473], [35.008, -84.889]];
  map.fitBounds(AL_BOUNDS);

  // NOAA RFC QPE (ArcGIS REST). Layer 56 = "Last 7 Days Observed (Image)".
  const rfcQpe = L.esri.dynamicMapLayer({
    url: 'https://mapservices.weather.noaa.gov/raster/rest/services/obs/rfc_qpe/MapServer',
    layers: [56],
    opacity: 0.45,           // <-- lighter so details below show through better
    f: 'image',
    pane: 'qpe'
  }).addTo(map);

  // UI toggles
  const rainToggle = document.getElementById('rainToggle');
  rainToggle.addEventListener('change', () => rainToggle.checked ? rfcQpe.addTo(map) : map.removeLayer(rfcQpe));

  // Trails layer placeholder
  const trailsLayer = L.geoJSON(null, {
    pane: 'counties', // draw trails above basemap, below the bold state outline
    style: { color:'#0066cc', weight:3 },
    onEachFeature: (f, layer)=>{
      layer.on('click', ()=>{
        let latlng = null;
        try {
          const coords = (f.geometry.type === 'LineString')
            ? f.geometry.coordinates[0]
            : (f.geometry.type === 'MultiLineString' ? f.geometry.coordinates[0][0] : null);
          if (coords) latlng = {lng: coords[0], lat: coords[1]};
        } catch(e){}
        const name = f.properties && (f.properties.name || f.properties.ref || 'Trail');
        const addrHint = f.properties && f.properties.operator ? 'Operator: ' + f.properties.operator : '';
        const div = document.createElement('div');
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          ${addrHint ? `<div style="margin:2px 0">${addrHint}</div>`:''}
          <div>${latlng ? `Trailhead (approx): <code>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</code>` : 'Coordinates unavailable'}</div>
          <button class="copy-btn">Copy coordinates</button>
        `;
        const center = layer.getBounds ? layer.getBounds().getCenter() : (latlng ? latlng : map.getCenter());
        L.popup().setLatLng(center).setContent(div).openOn(map);
        const btn = div.querySelector('.copy-btn');
        btn.addEventListener('click', ()=>{
          const text = latlng ? `${latlng.lat}, ${latlng.lng}` : `${center.lat}, ${center.lng}`;
          navigator.clipboard.writeText(text);
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent='Copy coordinates', 1200);
        });
      });
    }
  }).addTo(map);

  const trailsToggle = document.getElementById('trailsToggle');
  trailsToggle.addEventListener('change', ()=>{
    trailsToggle.checked ? trailsLayer.addTo(map) : map.removeLayer(trailsLayer);
  });

  // ===== Boundaries (Counties + State outline) with automatic fallback =====
  const countyHover = document.getElementById('countyHover');
  const backBtn = document.getElementById('backBtn');
  let countiesLayer = null, stateLayer = null, currentCounty = null;

  function styleCounty(){ return { color:'#333', weight:1.5, fillOpacity:0, opacity:0.9 }; } // outline only
  function styleCountyHover(){ return { weight:2.5, color:'#111' }; }
  function styleState(){ return { color:'#000', weight:2.5, fillOpacity:0, opacity:1 }; }       // bold state outline

  function highlightCounty(e){
    const layer = e.target;
    layer.setStyle(styleCountyHover());
    const n = (layer.feature.properties.NAME || layer.feature.properties.NAME10 || layer.feature.properties.NAME20 || layer.feature.properties.NAMELSAD || '').toString();
    if (n) { countyHover.textContent = n + ' County'; countyHover.style.display='block'; }
  }
  function resetHighlight(e){
    countiesLayer.resetStyle(e.target);
    countyHover.style.display='none';
  }
  function zoomCounty(e){
    hideMsg();
    const layer = e.target;
    currentCounty = layer;
    map.fitBounds(layer.getBounds(), { padding:[20,20] });
    backBtn.style.display = 'inline-block';
    loadTrailsForBounds(layer.getBounds());
  }
  function onEachCounty(feature, layer){
    layer.on({ mouseover: highlightCounty, mouseout: resetHighlight, click: zoomCounty });
  }

  async function tryFetch(url){
    const r = await fetch(url, {mode:'cors'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  async function loadBoundaries(){
    // 1) Try Alabama GIS service for counties
    const AL_COUNTIES = 'https://maps.alabama.gov/ALGOGIS/rest/services/Counties/MapServer/0/query?where=1%3D1&outFields=*&returnGeometry=true&f=geojson';
    // 2) Fallback: U.S. Census TIGERweb for counties (STATE='01'), and state outline
    const TIGER_COUNTIES = "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/1/query?where=STATE%3D%2701%27&outFields=NAME,STATE,COUNTY,NAMELSAD&returnGeometry=true&f=geojson";
    const TIGER_STATE    = "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/0/query?where=STATE%3D%2701%27&outFields=NAME,STATE&returnGeometry=true&f=geojson";

    let countiesData = null;
    try {
      countiesData = await tryFetch(AL_COUNTIES);
    } catch (e) {
      // fall back to TIGERweb
      try {
        countiesData = await tryFetch(TIGER_COUNTIES);
      } catch (e2) {
        showMsg('Could not load county boundaries. You can still use the statewide view.');
        console.error('County load failed (both sources):', e, e2);
      }
    }

    if (countiesData){
      countiesLayer = L.geoJSON(countiesData, { pane:'counties', style: styleCounty, onEachFeature }).addTo(map);
      hideMsg();
    }

    // Load state outline from TIGERweb (reliable + small)
    try {
      const stateData = await tryFetch(TIGER_STATE);
      stateLayer = L.geoJSON(stateData, { pane:'state', style: styleState }).addTo(map);
    } catch (e) {
      console.warn('State outline failed to load:', e);
    }
  }

  backBtn.addEventListener('click', ()=>{
    currentCounty = null;
    map.fitBounds(AL_BOUNDS);
    backBtn.style.display = 'none';
    trailsLayer.clearLayers();
  });

  loadBoundaries();

  // Overpass trails loader
  async function loadTrailsForBounds(bounds){
    trailsLayer.clearLayers();
    showMsg('Loading trailsâ€¦');
    const bbox = [bounds.getSouth(), bounds.getWest(), bounds.getNorth(), bounds.getEast()].join(',');
    const query = `
      [out:json][timeout:25];
      (
        relation["route"="hiking"](${bbox});
        way["highway"~"path|footway|track"]["foot"!~"no"](${bbox});
      );
      out geom;
    `;
    const url = 'https://overpass-api.de/api/interpreter';
    try{
      const res = await fetch(url, { method:'POST', body: query, headers:{'Content-Type':'text/plain'} });
      const data = await res.json();
      const features = osmtogeojson(data).features;
      if (!features.length) showMsg('No mapped trails found for this county (OSM). Try zooming or another county.');
      else hideMsg();
      trailsLayer.addData(features);
    } catch(err){
      showMsg('Could not load trails right now. Please try again.');
      console.error('Overpass/OSM error', err);
    }
  }
})();
</script>
