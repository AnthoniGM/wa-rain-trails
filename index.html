<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/esri-leaflet@3.0.11/dist/esri-leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0/osmtogeojson.js" crossorigin=""></script>
<script>
(function(){
  const msg = document.getElementById('msgBox');
  const err = document.getElementById('errBox');
  const showMsg = (t)=>{ msg.textContent=t; msg.style.display='block'; };
  const hideMsg = ()=>{ msg.style.display='none'; };
  const showErr = (t)=>{ err.textContent=t; err.style.display='block'; console.error(t); };
  const hideErr = ()=>{ err.style.display='none'; };

  // Map
  const map = L.map('map', { zoomControl: true, preferCanvas: true });
  map.zoomControl.setPosition('topright');

  // Panes (z-order)
  map.createPane('basemap');   map.getPane('basemap').style.zIndex   = 300;
  map.createPane('qpe');       map.getPane('qpe').style.zIndex       = 350;
  map.createPane('counties');  map.getPane('counties').style.zIndex  = 500;
  map.createPane('trails');    map.getPane('trails').style.zIndex    = 520;
  map.createPane('state');     map.getPane('state').style.zIndex     = 550;

  const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    pane:'basemap',
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Fit to Alabama
  const AL_BOUNDS = [[30.137, -88.473], [35.008, -84.889]];
  map.fitBounds(AL_BOUNDS);

  // NOAA 7‑day rain (above basemap)
  let rfcQpe;
  try {
    rfcQpe = L.esri.dynamicMapLayer({
      url: 'https://mapservices.weather.noaa.gov/raster/rest/services/obs/rfc_qpe/MapServer',
      layers: [56],
      opacity: 0.45,
      f: 'image',
      pane: 'qpe'
    }).addTo(map);
  } catch (e) {
    showErr('Rain layer failed to initialize.');
  }

  const rainToggle = document.getElementById('rainToggle');
  rainToggle.addEventListener('change', () => {
    if (!rfcQpe) return;
    rainToggle.checked ? rfcQpe.addTo(map) : map.removeLayer(rfcQpe);
  });

  // Trails layer
  const trailsLayer = L.geoJSON(null, {
    pane: 'trails',
    style: { color:'#0066cc', weight:3 },
    onEachFeature: (f, layer)=>{
      layer.on('click', ()=>{
        let latlng = null;
        try {
          const coords = (f.geometry.type === 'LineString')
            ? f.geometry.coordinates[0]
            : (f.geometry.type === 'MultiLineString' ? f.geometry.coordinates[0][0] : null);
          if (coords) latlng = {lng: coords[0], lat: coords[1]};
        } catch(e){}
        const name = f.properties && (f.properties.name || f.properties.ref || 'Trail');
        const addrHint = f.properties && f.properties.operator ? 'Operator: ' + f.properties.operator : '';
        const div = document.createElement('div');
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          ${addrHint ? `<div style="margin:2px 0">${addrHint}</div>`:''}
          <div>${latlng ? `Trailhead (approx): <code>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</code>` : 'Coordinates unavailable'}</div>
          <button class="copy-btn">Copy coordinates</button>
        `;
        const center = layer.getBounds ? layer.getBounds().getCenter() : (latlng ? latlng : map.getCenter());
        L.popup().setLatLng(center).setContent(div).openOn(map);
        const btn = div.querySelector('.copy-btn');
        btn.addEventListener('click', ()=>{
          const text = latlng ? `${latlng.lat}, ${latlng.lng}` : `${center.lat}, ${center.lng}`;
          navigator.clipboard.writeText(text);
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent='Copy coordinates', 1200);
        });
      });
    }
  }).addTo(map);

  const trailsToggle = document.getElementById('trailsToggle');
  trailsToggle.addEventListener('change', ()=>{
    trailsToggle.checked ? trailsLayer.addTo(map) : map.removeLayer(trailsLayer);
  });

  // ===== Boundaries via Esri‑Leaflet FeatureLayer =====
  const countyHover = document.getElementById('countyHover');
  const backBtn = document.getElementById('backBtn');
  let countiesLayer = null, stateLayer = null, currentCounty = null;

  const styleCounty      = () => ({ color:'#333', weight:1.5, fillOpacity:0, opacity:0.9 });
  const styleCountyHover = () => ({ color:'#111', weight:2.5, fillOpacity:0, opacity:1 });
  const styleState       = () => ({ color:'#000', weight:2.5, fillOpacity:0, opacity:1 });

  function highlightCounty(e){
    e.layer.setStyle(styleCountyHover());
    const f = e.layer.feature;
    const props = f && f.properties || {};
    const n = (props.NAME || props.NAMELSAD || props.NAME10 || props.NAME20 || '').toString();
    if (n) { countyHover.textContent = n + ' County'; countyHover.style.display='block'; }
  }
  function resetHighlight(e){
    countiesLayer.resetStyle(e.layer);
    countyHover.style.display='none';
  }
  function zoomCounty(e){
    const layer = e.layer;
    currentCounty = layer;
    map.fitBounds(layer.getBounds(), { padding:[20,20] });
    backBtn.style.display = 'inline-block';
    loadTrailsForBounds(layer.getBounds());
  }

  // Primary: Alabama GIS MapServer/0 (counties are already in WGS84)
  const AL_COUNTIES_URL = 'https://maps.alabama.gov/ALGOGIS/rest/services/Counties/MapServer/0';

  // Fallback: TIGERweb "States and Counties" — Counties layer id 55 (Census 2020 set)
  const TIGER_COUNTIES_URL = 'https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/55';
  // Fallback for state outline: TIGERweb States layer id 54
  const TIGER_STATE_URL    = 'https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/54';

  function attachCountyEvents(layer){
    layer.on('mouseover', highlightCounty);
    layer.on('mouseout', resetHighlight);
    layer.on('click', zoomCounty);
  }

  function loadCounties(){
    // Try Alabama GIS first
    countiesLayer = L.esri.featureLayer({
      url: AL_COUNTIES_URL,
      pane: 'counties',
      where: '1=1',
      style: styleCounty,
      precision: 6
    })
    .on('load', function(e){
      // Loaded successfully
    })
    .on('createfeature', function(e){
      attachCountyEvents(e.layer);
    })
    .on('requesterror', function(){
      // Switch to TIGERweb fallback
      if (countiesLayer) { map.removeLayer(countiesLayer); }
      countiesLayer = L.esri.featureLayer({
        url: TIGER_COUNTIES_URL,
        pane: 'counties',
        where: "STATE='01'",
        style: styleCounty,
        precision: 6
      })
      .on('createfeature', function(e){ attachCountyEvents(e.layer); })
      .addTo(map);
    })
    .addTo(map);
  }

  function loadStateOutline(){
    // Use TIGERweb States outline (works widely)
    stateLayer = L.esri.featureLayer({
      url: TIGER_STATE_URL,
      pane: 'state',
      where: "STATE='01'",
      style: styleState,
      precision: 6,
      simplifyFactor: 0.5
    }).addTo(map);
  }

  backBtn.addEventListener('click', ()=>{
    currentCounty = null;
    map.fitBounds(AL_BOUNDS);
    backBtn.style.display = 'none';
    trailsLayer.clearLayers();
  });

  loadCounties();
  loadStateOutline();

  // Trails loader (Overpass)
  async function loadTrailsForBounds(bounds){
    trailsLayer.clearLayers();
    showMsg('Loading trails…');
    const bbox = [bounds.getSouth(), bounds.getWest(), bounds.getNorth(), bounds.getEast()].join(',');
    const query = `
      [out:json][timeout:25];
      (
        relation["route"="hiking"](${bbox});
        way["highway"~"path|footway|track"]["foot"!~"no"](${bbox});
      );
      out geom;
    `;
    const url = 'https://overpass-api.de/api/interpreter';
    try{
      const res = await fetch(url, { method:'POST', body: query, headers:{'Content-Type':'text/plain'} });
      const data = await res.json();
      const features = osmtogeojson(data).features;
      if (!features.length) showMsg('No mapped trails found for this county (OSM). Try zooming or another county.');
      else hideMsg();
      trailsLayer.addData(features);
    } catch(err){
      showMsg('Could not load trails right now. Please try again.');
      showErr('Overpass request failed.');
    }
  }
})();
</script>
