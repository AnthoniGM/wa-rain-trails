<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alabama Rain + Trails</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
<style>
  html, body { margin:0; height:100%; }
  #app { width:100%; height:100vh; position:relative; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  #map { width:100%; height:100%; }
  .toolbar {
    position:absolute; top:10px; left:10px; z-index:1200; /* raised above Leaflet controls */
    background:#fff; border-radius:12px; padding:8px 10px; box-shadow:0 2px 10px rgba(0,0,0,.2);
    display:flex; gap:8px; align-items:center; font-size:14px;
  }
  .btn { cursor:pointer; border:none; border-radius:10px; padding:6px 10px; background:#f2f2f2; }
  .btn:hover { background:#e8e8e8; }
  .legend {
    position:absolute; bottom:10px; left:10px; z-index:1100;
    background:#fff; border-radius:12px; padding:8px 10px; box-shadow:0 2px 10px rgba(0,0,0,.2); font-size:12px;
    max-width: 280px; line-height:1.35;
  }
  .county-hover { position:absolute; top:10px; right:10px; z-index:1100; 
    background:#212121; color:#fff; padding:6px 10px; border-radius:10px; opacity:0.9; display:none;}
  .back { display:none; }
  .leaflet-popup-content button.copy-btn { margin-top:6px; }
  .msg {
    position:absolute; top:60px; left:10px; z-index:1100; background:#fff; border-left:4px solid #1976d2;
    padding:8px 10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:13px; display:none;
  }
  .err {
    position:absolute; top:100px; left:10px; z-index:1100; background:#fff; border-left:4px solid #d32f2f;
    padding:8px 10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.15); font-size:13px; display:none;
  }
</style>
</head>
<body>
<div id="app">
  <div class="toolbar">
    <button id="backBtn" class="btn back" title="Back to Alabama">← Back</button>
    <label><input id="rainToggle" type="checkbox" checked/> Rain (7‑day)</label>
    <label><input id="trailsToggle" type="checkbox" checked/> Trails</label>
  </div>
  <div class="msg" id="msgBox"></div>
  <div class="err" id="errBox"></div>
  <div class="county-hover" id="countyHover"></div>
  <div id="map"></div>
  <div class="legend">
    <div><strong>Alabama Rain (Last 7 Days) + Trails</strong></div>
    <div>• Hover a county to see its name. Click to drill in.</div>
    <div>• Click a trail to copy trailhead coordinates.</div>
    <div style="margin-top:6px; font-size:11px;">
      Rain: NOAA/NWS RFC Observed QPE. Trails: OpenStreetMap via Overpass.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/esri-leaflet@3.0.11/dist/esri-leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0/osmtogeojson.js" crossorigin=""></script>
<script>
(function(){
  const msg = document.getElementById('msgBox');
  const err = document.getElementById('errBox');
  const showMsg = (t)=>{ msg.textContent=t; msg.style.display='block'; };
  const hideMsg = ()=>{ msg.style.display='none'; };
  const showErr = (t)=>{ err.textContent=t; err.style.display='block'; console.error(t); };
  const hideErr = ()=>{ err.style.display='none'; };

  // Map
  const map = L.map('map', { zoomControl: true, preferCanvas: true });
  map.zoomControl.setPosition('topright'); // move zoom so it doesn't cover the toolbar

  // Panes: higher zIndex draws on top
  map.createPane('basemap');   map.getPane('basemap').style.zIndex   = 300;
  map.createPane('qpe');       map.getPane('qpe').style.zIndex       = 350; // ABOVE basemap so it's visible
  map.createPane('counties');  map.getPane('counties').style.zIndex  = 500;
  map.createPane('trails');    map.getPane('trails').style.zIndex    = 520;
  map.createPane('state');     map.getPane('state').style.zIndex     = 550;

  const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    pane:'basemap',
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Fit to Alabama
  const AL_BOUNDS = [[30.137, -88.473], [35.008, -84.889]];
  map.fitBounds(AL_BOUNDS);

  // NOAA 7‑day rain (now above basemap, a bit lighter)
  let rfcQpe;
  try {
    rfcQpe = L.esri.dynamicMapLayer({
      url: 'https://mapservices.weather.noaa.gov/raster/rest/services/obs/rfc_qpe/MapServer',
      layers: [56],
      opacity: 0.45,
      f: 'image',
      pane: 'qpe'
    }).addTo(map);
  } catch (e) {
    showErr('Rain layer failed to initialize.');
  }

  // UI toggle
  const rainToggle = document.getElementById('rainToggle');
  rainToggle.addEventListener('change', () => {
    if (!rfcQpe) return;
    rainToggle.checked ? rfcQpe.addTo(map) : map.removeLayer(rfcQpe);
  });

  // Trails layer
  const trailsLayer = L.geoJSON(null, {
    pane: 'trails',
    style: { color:'#0066cc', weight:3 },
    onEachFeature: (f, layer)=>{
      layer.on('click', ()=>{
        let latlng = null;
        try {
          const coords = (f.geometry.type === 'LineString')
            ? f.geometry.coordinates[0]
            : (f.geometry.type === 'MultiLineString' ? f.geometry.coordinates[0][0] : null);
          if (coords) latlng = {lng: coords[0], lat: coords[1]};
        } catch(e){}
        const name = f.properties && (f.properties.name || f.properties.ref || 'Trail');
        const addrHint = f.properties && f.properties.operator ? 'Operator: ' + f.properties.operator : '';
        const div = document.createElement('div');
        div.innerHTML = `
          <div><strong>${name}</strong></div>
          ${addrHint ? `<div style="margin:2px 0">${addrHint}</div>`:''}
          <div>${latlng ? `Trailhead (approx): <code>${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</code>` : 'Coordinates unavailable'}</div>
          <button class="copy-btn">Copy coordinates</button>
        `;
        const center = layer.getBounds ? layer.getBounds().getCenter() : (latlng ? latlng : map.getCenter());
        L.popup().setLatLng(center).setContent(div).openOn(map);
        const btn = div.querySelector('.copy-btn');
        btn.addEventListener('click', ()=>{
          const text = latlng ? `${latlng.lat}, ${latlng.lng}` : `${center.lat}, ${center.lng}`;
          navigator.clipboard.writeText(text);
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent='Copy coordinates', 1200);
        });
      });
    }
  }).addTo(map);

  const trailsToggle = document.getElementById('trailsToggle');
  trailsToggle.addEventListener('change', ()=>{
    trailsToggle.checked ? trailsLayer.addTo(map) : map.removeLayer(trailsLayer);
  });

  // Boundaries (with fallback)
  const countyHover = document.getElementById('countyHover');
  const backBtn = document.getElementById('backBtn');
  let countiesLayer = null, stateLayer = null, currentCounty = null;

  function styleCounty(){ return { color:'#333', weight:1.5, fillOpacity:0, opacity:0.9 }; }
  function styleCountyHover(){ return { weight:2.5, color:'#111' }; }
  function styleState(){ return { color:'#000', weight:2.5, fillOpacity:0, opacity:1 }; }

  function highlightCounty(e){
    const layer = e.target;
    layer.setStyle(styleCountyHover());
    const n = (layer.feature.properties.NAME || layer.feature.properties.NAME10 || layer.feature.properties.NAME20 || layer.feature.properties.NAMELSAD || '').toString();
    if (n) { countyHover.textContent = n + ' County'; countyHover.style.display='block'; }
  }
  function resetHighlight(e){
    countiesLayer.resetStyle(e.target);
    countyHover.style.display='none';
  }
  function zoomCounty(e){
    hideMsg();
    const layer = e.target;
    currentCounty = layer;
    map.fitBounds(layer.getBounds(), { padding:[20,20] });
    backBtn.style.display = 'inline-block';
    loadTrailsForBounds(layer.getBounds());
  }
  function onEachCounty(feature, layer){
    layer.on({ mouseover: highlightCounty, mouseout: resetHighlight, click: zoomCounty });
  }

  async function tryFetch(url){
    const r = await fetch(url, {mode:'cors'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  async function loadBoundaries(){
    // Primary: Alabama GIS
    const AL_COUNTIES = 'https://maps.alabama.gov/ALGOGIS/rest/services/Counties/MapServer/0/query?where=1%3D1&outFields=*&returnGeometry=true&f=geojson';
    // Fallbacks: TIGERweb
    const TIGER_COUNTIES = "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/1/query?where=STATE%3D%2701%27&outFields=NAME,STATE,COUNTY,NAMELSAD&returnGeometry=true&f=geojson";
    const TIGER_STATE    = "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/State_County/MapServer/0/query?where=STATE%3D%2701%27&outFields=NAME,STATE&returnGeometry=true&f=geojson";

    let countiesData = null;
    try {
      countiesData = await tryFetch(AL_COUNTIES);
    } catch (e) {
      try {
        countiesData = await tryFetch(TIGER_COUNTIES);
      } catch (e2) {
        showMsg('Could not load county boundaries. You can still use the statewide view.');
        showErr('County load failed (both sources).');
      }
    }

    if (countiesData){
      countiesLayer = L.geoJSON(countiesData, { pane:'counties', style: styleCounty, onEachFeature }).addTo(map);
      hideMsg(); hideErr();
    }

    try {
      const stateData = await tryFetch(TIGER_STATE);
      stateLayer = L.geoJSON(stateData, { pane:'state', style: styleState }).addTo(map);
    } catch (e) {
      showErr('State outline failed to load.');
    }
  }

  backBtn.addEventListener('click', ()=>{
    currentCounty = null;
    map.fitBounds(AL_BOUNDS);
    backBtn.style.display = 'none';
    trailsLayer.clearLayers();
  });

  loadBoundaries();

  // Trails loader
  async function loadTrailsForBounds(bounds){
    trailsLayer.clearLayers();
    showMsg('Loading trails…');
    const bbox = [bounds.getSouth(), bounds.getWest(), bounds.getNorth(), bounds.getEast()].join(',');
    const query = `
      [out:json][timeout:25];
      (
        relation["route"="hiking"](${bbox});
        way["highway"~"path|footway|track"]["foot"!~"no"](${bbox});
      );
      out geom;
    `;
    const url = 'https://overpass-api.de/api/interpreter';
    try{
      const res = await fetch(url, { method:'POST', body: query, headers:{'Content-Type':'text/plain'} });
      const data = await res.json();
      const features = osmtogeojson(data).features;
      if (!features.length) showMsg('No mapped trails found for this county (OSM). Try zooming or another county.');
      else hideMsg();
      trailsLayer.addData(features);
    } catch(err){
      showMsg('Could not load trails right now. Please try again.');
      showErr('Overpass request failed.');
    }
  }
})();
</script>
</body>
</html>
